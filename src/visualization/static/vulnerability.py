"""Language Prior Vulnerability Index: how much each benchmark depends on vision."""

import pandas as pd
import matplotlib.pyplot as plt
import numpy as np

from .style import apply_style, save_figure, BENCHMARK_NAMES, BENCHMARK_ORDER


def plot_vulnerability_index(df: pd.DataFrame, output_dir: str):
    """Create horizontal bar chart of Language Prior Vulnerability Index.

    LPV = 1 - (no_image_accuracy / normal_accuracy)
    LPV = 0: image not needed (pure language prior)
    LPV = 1: completely depends on image

    Args:
        df: Summary DataFrame with columns: benchmark, condition, accuracy.
        output_dir: Directory to save plots.
    """
    apply_style()

    benchmarks = [b for b in BENCHMARK_ORDER if b in df["benchmark"].unique()]

    # Need both normal and no_image conditions
    if "normal" not in df["condition"].values or "no_image" not in df["condition"].values:
        return

    lpv_data = []
    for bench in benchmarks:
        normal = df[(df["benchmark"] == bench) & (df["condition"] == "normal")]
        no_img = df[(df["benchmark"] == bench) & (df["condition"] == "no_image")]

        if len(normal) == 0 or len(no_img) == 0:
            continue

        normal_acc = normal["accuracy"].values[0]
        no_img_acc = no_img["accuracy"].values[0]

        if normal_acc > 0:
            lpv = 1 - (no_img_acc / normal_acc)
        else:
            lpv = 0

        lpv_data.append({
            "benchmark": bench,
            "lpv": lpv,
            "normal_acc": normal_acc * 100,
            "no_image_acc": no_img_acc * 100,
        })

    if not lpv_data:
        return

    # Sort by LPV (most vision-dependent first)
    lpv_data.sort(key=lambda x: x["lpv"], reverse=True)

    fig, ax = plt.subplots(figsize=(10, 5))

    y_pos = np.arange(len(lpv_data))
    lpv_values = [d["lpv"] for d in lpv_data]
    bench_labels = [BENCHMARK_NAMES.get(d["benchmark"], d["benchmark"]) for d in lpv_data]

    # Color by magnitude
    colors = plt.cm.RdYlGn_r(np.array(lpv_values))

    bars = ax.barh(y_pos, lpv_values, color=colors, edgecolor="white", linewidth=0.5)

    # Add annotations
    for i, d in enumerate(lpv_data):
        ax.text(
            d["lpv"] + 0.02, i,
            f"LPV={d['lpv']:.2f}  ({d['normal_acc']:.0f}% -> {d['no_image_acc']:.0f}%)",
            va="center", fontsize=9,
        )

    ax.set_yticks(y_pos)
    ax.set_yticklabels(bench_labels)
    ax.set_xlabel("Language Prior Vulnerability Index")
    ax.set_title("Vision Dependence by Benchmark\n(1 = fully depends on image, 0 = image not needed)")
    ax.set_xlim(0, max(lpv_values) + 0.25)
    ax.axvline(0.5, color="gray", linestyle="--", linewidth=0.8, alpha=0.5)
    ax.invert_yaxis()

    fig.tight_layout()
    save_figure(fig, output_dir, "vulnerability_index")
